<project name="DASE_WebUI" default="execute" basedir=".">
    <description>ADTECH - Ad Player build script.</description>
	
	<property name="version" value="0.3.45"/>
	<property name="jsfilename" value="adplayer-${version}"/>
	<property name="cssfilename" value="adplayer-${version}"/>
	
	<property name="src" location="src"/>
	<property name="lib" location="lib"/>
	<property name="bin" location="bin"/>

	<property name="dist.revision" value="dev"/>
	
	<tstamp>
		<format property="today" pattern="MMddyy" locale="en,UK"/>
	</tstamp>
	
	<target name="init">
    	<tstamp/>
    	<mkdir dir="${bin}"/>
	</target>

	<target name="copy" depends="init" description="copy source to bin">
  		<copy todir="${bin}" file="index.html" overwrite="true" />
		<replace file="${bin}/index.html" token="_@ADPLAYER_JS_FILE@_" value="${jsfilename}.js" />
		<replace file="${bin}/index.html" token="_@ADPLAYER_JS_FILE_MIN@_" value="${jsfilename}.min.js" />
		<replace file="${bin}/index.html" token="_@ADPLAYER_CSS_FILE@_" value="${cssfilename}-style.css" />
		<replace file="${bin}/index.html" token="_@ADPLAYER_CSS-IE_FILE@_" value="${cssfilename}-style-ie.css" />
		<replace file="${bin}/index.html" token="_@VERSION@_" value="${version} (${dist.revision}.${today})" />
		
  		<copy todir="${bin}" file="iframe.html" overwrite="true" />
		<replace file="${bin}/iframe.html" token="_@ADPLAYER_JS_FILE@_" value="${jsfilename}.js" />
		<replace file="${bin}/iframe.html" token="_@ADPLAYER_JS_FILE_MIN@_" value="${jsfilename}.min.js" />
		<replace file="${bin}/iframe.html" token="_@ADPLAYER_CSS_FILE@_" value="${cssfilename}-style.css" />
		<replace file="${bin}/iframe.html" token="_@ADPLAYER_CSS-IE_FILE@_" value="${cssfilename}-style-ie.css" />
		<replace file="${bin}/iframe.html" token="_@VERSION@_" value="${version} (${dist.revision}.${today})" />		
		
		<copy tofile="${bin}/js/${jsfilename}.js" file="${src}/AdPlayerManager.js" overwrite="true" />
  	</target>
	
	<target name="compile" depends="copy" description="compile the source">
		<concat destfile="${bin}/tmp/class_insert.txt" fixlastline="true">	
			<filelist dir="${src}">
				<!-- DEFINE Class list order -->
				<file name="PostMessage.js"/>
				<file name="PostMessageManager.js"/>
				<file name="PrivacyInfo.js"/>
				<file name="URLRequest.js"/>
				<file name="AdEvent.js"/>
				<file name="AbstractPlayer.js"/>
				<file name="DefaultPlayer.js"/>
				<file name="ReferencePlayer.js"/>
				<file name="IframePlayer.js"/>
				<file name="PlayerFactory.js"/>
				<file name="Util.js"/>
				<file name="AdPlayer.js"/>
			</filelist>
		</concat>		
		<loadfile property="CLASS_INSERTS" srcfile="${bin}/tmp/class_insert.txt" />
		<replace file="${bin}/js/${jsfilename}.js" token="_@VERSION@_" value="${version}.${dist.revision}.${today}" />
		<replace file="${bin}/js/${jsfilename}.js" token="/*@CLASS_INSERTS@*/" value="${CLASS_INSERTS}" />
	</target>
  
	<target name="js.minify" depends="compile">
	    <apply executable="java" parallel="false">
	        <fileset dir="${bin}/js/" includes="${jsfilename}.js"/>
	        <arg line="-jar"/>
	        <arg path="tools/yui/yuicompressor-2.4.2.jar"/>
	        <srcfile/>
	        <arg line="-o"/>
	        <mapper type="glob" from="*.js" to="${bin}/tmp/*-min.js"/>
	        <targetfile/>
	    </apply>
		<copy tofile="${bin}/js/${jsfilename}.min.js" file="${bin}/tmp/${jsfilename}-min.js" overwrite="true" />
	</target>

	<target name="css.minify" depends="js.minify">
		<mkdir dir="${bin}/css"/>
	    <apply executable="java" parallel="false">
	    	<fileset dir="${src}/css/" includes="*.css"/>
	        <arg line="-jar"/>
	    	<arg path="tools/yui/yuicompressor-2.4.2.jar"/>
	        <srcfile/>
	        <arg line="-o"/>
	    	<mapper type="glob" from="*.css" to="${bin}/css/${cssfilename}-*.css"/>
	        <targetfile/>
	    </apply>
	</target>
	
	<target name="jsdoc" depends="css.minify">
    	<taskdef name="jsdoctoolkit" classname="uk.co.darrenhurley.ant.tasks.JsDocToolkit" classpath="tools/jsdoc/jsdoc-toolkit-ant-task-1.1.2.jar;tools/jsdoc/jsrun.jar" />
		<jsdoctoolkit jsdochome="tools/jsdoc/" template="jsdoc" outputdir="${bin}/docs/">
		<source file="${bin}/js/${jsfilename}.js" />
		</jsdoctoolkit>
		<copy tofile="${bin}/docs/readme.txt" file="README" overwrite="true" />
	</target>
	
	<target name="execute" depends="jsdoc" description="execute the source">
		<delete dir="${bin}/tmp" />
	</target>
</project>